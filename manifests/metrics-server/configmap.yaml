apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-metrics-server
data:
  # Prometheus URL - ADJUST THIS to match your Prometheus service
  prometheus.url: "http://prometheus-kube-prometheus-prometheus.monitoring.svc:9090"
  
  # Metrics configuration for Deployments
  extension.metrics.deployments: |
    metrics:
      - name: CPU Usage
        description: Pod CPU usage  
        graphType: area
        query: |
          sum(
            irate(
              container_cpu_usage_seconds_total{namespace="{{.metadata.namespace}}", pod=~"{{.metadata.name}}-.*"}[2m]
            )
          ) by (pod)
      - name: Memory Usage
        description: Pod memory usage
        graphType: area
        query: |
          sum(
            container_memory_working_set_bytes{namespace="{{.metadata.namespace}}", pod=~"{{.metadata.name}}-.*"}
          ) by (pod)
      - name: Replicas
        description: Deployment replicas
        graphType: line
        query: |
          sum(
            kube_deployment_status_replicas{namespace="{{.metadata.namespace}}", deployment="{{.metadata.name}}"}
          )

  # Metrics configuration for Pods
  extension.metrics.pods: |
    metrics:
      - name: CPU Usage
        description: CPU usage by container
        graphType: area
        query: |
          sum(
            irate(
              container_cpu_usage_seconds_total{namespace="{{.metadata.namespace}}", pod="{{.metadata.name}}"}[2m]
            )
          ) by (container)
      - name: Memory Usage
        description: Memory usage by container
        graphType: area
        query: |
          sum(
            container_memory_working_set_bytes{namespace="{{.metadata.namespace}}", pod="{{.metadata.name}}"}
          ) by (container)
      - name: Network I/O
        description: Network traffic
        graphType: line
        query: |
          sum(
            rate(
              container_network_transmit_bytes_total{namespace="{{.metadata.namespace}}", pod="{{.metadata.name}}"}[2m]
            )
          ) by (pod)

  # Metrics configuration for Argo Rollouts
  extension.metrics.rollouts: |
    metrics:
      - name: CPU Usage
        description: Pod CPU usage
        graphType: area
        query: |
          sum(
            irate(
              container_cpu_usage_seconds_total{namespace="{{.metadata.namespace}}", pod=~"{{.metadata.name}}-.*"}[2m]
            )
          ) by (pod)
      - name: Memory Usage
        description: Pod memory usage
        graphType: area
        query: |
          sum(
            container_memory_working_set_bytes{namespace="{{.metadata.namespace}}", pod=~"{{.metadata.name}}-.*"}
          ) by (pod)
      - name: Replicas
        description: Rollout replicas
        graphType: line
        query: |
          sum(
            kube_deployment_status_replicas{namespace="{{.metadata.namespace}}", deployment=~"{{.metadata.name}}-.*"}
          )